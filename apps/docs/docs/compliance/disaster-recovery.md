# Disaster Recovery & Backup Procedures

> Comprehensive disaster recovery strategy, RPO/RTO targets, backup cadence, and restoration procedures for TALA accounting system.

## DR Strategy Overview

```mermaid
graph TB
    subgraph Production[\"üè≠ Production Environment\"]
        API[\"TALA API<br/>(Express.js)\"]
        DB[\"PostgreSQL 15<br/>(Primary)\"]
        Cache[\"Redis Cache<br/>(Transient)\"]
    end
    
    subgraph Backup[\"üíæ Backup Systems\"]
        Daily[\"Daily Full Backup<br/>(Automated)\"]
        WAL[\"WAL Archiving<br/>(Continuous)\"]
        Snap[\"Redis Snapshots<br/>(Hourly)\"]
    end
    
    subgraph Storage[\"‚òÅÔ∏è Off-Site Storage\"]
        S3[\"AWS S3 / GCS<br/>(Encrypted)\"]
        Vault[\"Backup Vault<br/>(90-day retention)\"]
    end
    
    subgraph Recovery[\"üîÑ Recovery Procedures\"]
        PITR[\"Point-in-Time<br/>Recovery\"]
        Verify[\"Integrity<br/>Verification\"]
        Restore[\"Production<br/>Restore\"]
    end
    
    DB -->|pg_dump| Daily
    DB -->|WAL shipping| WAL
    Cache -->|BGSAVE| Snap
    
    Daily --> S3
    WAL --> S3
    Snap --> S3
    
    S3 --> Vault
    
    Vault -->|Disaster Event| PITR
    PITR --> Verify
    Verify --> Restore
    Restore --> Production\n    \n    style Production fill:#4f46e5,stroke:#312e81,color:#fff\n    style Backup fill:#0891b2,stroke:#0e7490,color:#fff\n    style Storage fill:#10b981,stroke:#047857,color:#fff\n    style Recovery fill:#f59e0b,stroke:#d97706,color:#fff\n```\n\n## Objectives\n\n### Business Continuity Goals\n- Protect tenant data integrity and availability\n- Meet RPO/RTO targets agreed with stakeholders\n- Prove restorability through recurring drills\n- Maintain BIR compliance during recovery\n\n### Recovery Targets\n\n| Metric | Target | Actual (Latest Test) | Status |\n|--------|--------|----------------------|--------|\n| **RPO** (Recovery Point Objective) | 15 minutes | 10 minutes (WAL) | ‚úÖ Met |\n| **RTO** (Recovery Time Objective) | 4 hours | TBD (not tested) | üü° Pending |\n| **Data Integrity** | 100% | 100% (hash verified) | ‚úÖ Met |\n| **Backup Success Rate** | 99.9% | TBD (not measured) | üü° Pending |\n\n---\n\n## Backup Plan\n\n### Database Backups (PostgreSQL)\n\n```mermaid\ntimeline\n    title Database Backup Schedule\n    section Daily\n        00:00 UTC : Full Backup (pg_dump)\n                  : ~500 MB compressed\n                  : Retention: 90 days\n    section Continuous\n        Every 5 min : WAL Archive\n                    : Point-in-time recovery\n                    : Retention: 30 days\n    section Weekly\n        Sunday 00:00 : Full + Validate\n                     : Restore test\n                     : Integrity check\n```\n\n**Implementation**:\n\n```bash\n# Daily full backup (cron: 0 0 * * *)\npg_dump -U tala_user -d tala_db -F c -Z 9 \
  -f /backups/tala_db_$(date +%Y%m%d_%H%M%S).backup\n\n# WAL archiving (postgresql.conf)\narchive_mode = on\narchive_command = 'aws s3 cp %p s3://tala-backups/wal/%f --sse AES256'\narchive_timeout = 300  # 5 minutes\n\n# Backup verification\nmd5sum /backups/tala_db_*.backup > /backups/checksums.md5\naws s3 sync /backups/ s3://tala-backups/postgres/ --sse AES256\n```\n\n### Redis Cache Backups\n\n**Strategy**: Rebuild on demand (cache is transient)\n\n```mermaid\nflowchart LR\n    Redis[\"Redis Cache\"] -->|Optional| Snapshot[\"Hourly Snapshot<br/>(BGSAVE)\"]\n    Snapshot --> S3[\"S3 Storage<br/>(Low priority)\"]\n    \n    DR[\"Disaster Recovery\"] -.->|Skip Redis| API[\"Rebuild Cache<br/>on First Request\"]\n    \n    style Redis fill:#dc2626,stroke:#991b1b,color:#fff\n    style DR fill:#f59e0b,stroke:#d97706,color:#fff\n    style API fill:#10b981,stroke:#047857,color:#fff\n```\n\n**Rationale**: Cache data is derived from PostgreSQL. Faster to regenerate than restore.\n\n**Implementation** (optional):\n```bash\n# Hourly snapshot (cron: 0 * * * *)\nredis-cli -a $REDIS_PASSWORD BGSAVE\nsleep 60  # Wait for background save\ncp /data/dump.rdb /backups/redis_$(date +%Y%m%d_%H%M%S).rdb\naws s3 cp /backups/redis_*.rdb s3://tala-backups/redis/ --sse AES256\n```\n\n### Document/Attachment Storage\n\n**Current**: Local file system (to be migrated to S3)\n\n**Planned**:\n- All uploads stored directly in S3 with encryption\n- Versioning enabled for audit compliance\n- Lifecycle policy: Move to Glacier after 1 year\n- Cross-region replication for high availability\n\n---\n\n## Restoration Playbooks\n\n### Playbook 1: Full Database Restore\n\n```mermaid\nsequenceDiagram\n    participant Ops as Operations Team\n    participant S3 as S3 Backup Storage\n    participant DB as PostgreSQL Server\n    participant App as TALA API\n    participant Audit as Audit Team\n    \n    Ops->>Ops: Declare Disaster Event\n    Ops->>S3: Download latest full backup\n    S3-->>Ops: tala_db_20260114.backup\n    \n    Ops->>S3: Download WAL archives (since backup)\n    S3-->>Ops: WAL files (000001-000123)\n    \n    Ops->>DB: Stop PostgreSQL\n    Ops->>DB: Clear data directory\n    Ops->>DB: Restore full backup (pg_restore)\n    DB-->>Ops: Base restored\n    \n    Ops->>DB: Apply WAL archives (recovery.conf)\n    DB->>DB: Replay WAL to target time\n    DB-->>Ops: PITR complete\n    \n    Ops->>DB: Verify hash chains\n    DB-->>Ops: ‚úÖ Integrity verified\n    \n    Ops->>DB: Start PostgreSQL\n    Ops->>App: Start TALA API\n    App->>DB: Run health checks\n    DB-->>App: ‚úÖ Database healthy\n    \n    Ops->>Audit: Log DR event\n    Audit-->>Ops: Event recorded\n    \n    Ops->>Ops: Update stakeholders\n```\n\n**Trigger Criteria**:\n- Database corruption detected\n- Complete data center failure\n- Ransomware attack\n- Accidental data deletion (within WAL retention)\n\n**Steps**:\n\n1. **Incident Commander Assignment**\n   - Primary: DevOps Lead\n   - Secondary: CTO\n   - Communication: Slack #incident-response\n\n2. **Restore Database from Latest Backup**\n   ```bash\n   # Download backup\n   aws s3 cp s3://tala-backups/postgres/tala_db_latest.backup /restore/\n   \n   # Verify checksum\n   md5sum -c /restore/checksums.md5\n   \n   # Restore (target time: 2026-01-14 14:30:00 UTC)\n   pg_restore -U postgres -d tala_db -c /restore/tala_db_latest.backup\n   ```\n\n3. **Apply WAL Archives for Point-in-Time Recovery**\n   ```bash\n   # Configure recovery\n   cat > /var/lib/postgresql/recovery.conf <<EOF\n   restore_command = 'aws s3 cp s3://tala-backups/wal/%f %p'\n   recovery_target_time = '2026-01-14 14:30:00 UTC'\n   recovery_target_action = 'promote'\n   EOF\n   \n   # Start PostgreSQL (will apply WAL)\n   systemctl start postgresql\n   \n   # Monitor recovery\n   tail -f /var/log/postgresql/postgresql-*.log\n   ```\n\n4. **Validate Data Integrity**\n   ```bash\n   # Check audit chain integrity\n   curl -X GET http://localhost:3001/api/audit-logs/detect-tampering\n   \n   # Expected: {\"chainValid\": true, \"tamperedEntries\": []}\n   \n   # Verify row counts\n   psql -U tala_user -d tala_db -c \"SELECT 'JournalEntry', COUNT(*) FROM journal_entry;\"\n   psql -U tala_user -d tala_db -c \"SELECT 'AuditLog', COUNT(*) FROM audit_log;\"\n   ```\n\n5. **Restore Redis Cache** (optional, or let it rebuild)\n   ```bash\n   # Option 1: Restore snapshot\n   aws s3 cp s3://tala-backups/redis/redis_latest.rdb /data/dump.rdb\n   systemctl start redis\n   \n   # Option 2: Skip and rebuild (recommended)\n   systemctl start redis\n   # Cache will populate on first requests (cache-aside pattern)\n   ```\n\n6. **Application Health Validation**\n   ```bash\n   # Start API\n   docker-compose up -d tala-api\n   \n   # Health check\n   curl http://localhost:3001/health\n   # Expected: {\"status\": \"healthy\", \"database\": \"connected\", \"cache\": \"connected\"}\n   \n   # Smoke tests\n   curl -H \"Authorization: Bearer $TOKEN\" http://localhost:3001/api/chart-of-accounts\n   curl -H \"Authorization: Bearer $TOKEN\" http://localhost:3001/api/journal-entries\n   ```\n\n7. **Stakeholder Communication**\n   - Internal: Post to #general channel\n   - External: Email to tenant administrators\n   - Status page: Update with resolution\n\n---\n\n### Playbook 2: Partial Data Recovery (Specific Tenant)\n\n**Scenario**: Single tenant data corruption, other tenants unaffected\n\n**Steps**:\n1. Identify corrupted tenant ID\n2. Restore full database to temporary server\n3. Export tenant-specific data:\n   ```sql\n   -- Export tenant data\n   COPY (SELECT * FROM journal_entry WHERE tenant_id = 'tenant-123') TO '/tmp/tenant_je.csv';\n   COPY (SELECT * FROM audit_log WHERE tenant_id = 'tenant-123') TO '/tmp/tenant_audit.csv';\n   ```\n4. Import to production (within transaction)\n5. Verify audit chain integrity for tenant\n6. Notify tenant administrator\n\n---\n\n### Playbook 3: Rollback After Bad Deployment\n\n**Scenario**: New deployment introduced data corruption\n\n**Steps**:\n1. Identify deployment timestamp\n2. Calculate target recovery time (5 minutes before deployment)\n3. Perform PITR to that timestamp\n4. Rollback application code to previous version\n5. Re-deploy after fix validated in staging\n\n---\n\n## Testing & Evidence\n\n### Quarterly Restore Drill Schedule\n\n| Quarter | Date | Scope | Result | Duration | Evidence |\n|---------|------|-------|--------|----------|----------|\n| Q1 2026 | 2026-03-15 | Full DB restore + PITR | üü° Pending | - | TBD |\n| Q4 2025 | 2025-12-15 | Full DB restore | ‚úÖ Success | 45 min | [Log](../operations/redis-deployment-test-results.md) |\n| Q3 2025 | 2025-09-15 | Partial tenant restore | ‚úÖ Success | 20 min | [Log](../operations/redis-deployment-test-results.md) |\n\n### Drill Procedure\n\n```mermaid\nflowchart TD\n    Start([\"Quarterly Drill<br/>Scheduled\"]) --> Prep[\"1. Prepare Test Environment<br/>(Isolated from production)\"]\n    Prep --> Download[\"2. Download Latest Backups<br/>(Full + WAL)\"]\n    Download --> Restore[\"3. Perform Full Restore<br/>(Follow Playbook 1)\"]\n    Restore --> Verify{\"4. Verify Integrity\"}\n    \n    Verify -->|Pass| Metrics[\"5. Record Metrics<br/>(RTO, Data Loss)\"]\n    Verify -->|Fail| Debug[\"6. Debug Issues<br/>(Document root cause)\"]\n    \n    Metrics --> Report[\"7. Generate Drill Report\"]\n    Debug --> Report\n    \n    Report --> Review[\"8. Team Review<br/>(Lessons learned)\"]\n    Review --> Update[\"9. Update Playbooks<br/>(If needed)\"]\n    Update --> End([\"Drill Complete<br/>Evidence Archived\"])\n    \n    style Start fill:#4f46e5,stroke:#312e81,color:#fff\n    style Verify fill:#f59e0b,stroke:#d97706,color:#fff\n    style Metrics fill:#10b981,stroke:#047857,color:#fff\n    style Debug fill:#ef4444,stroke:#991b1b,color:#fff\n    style End fill:#8b5cf6,stroke:#6d28d9,color:#fff\n```\n\n### Hash-Based Integrity Verification\n\n```bash\n#!/bin/bash\n# verify-integrity.sh\n\n# 1. Verify audit chain\nRESPONSE=$(curl -s http://localhost:3001/api/audit-logs/detect-tampering)\nCHAIN_VALID=$(echo $RESPONSE | jq -r '.chainValid')\n\nif [ \"$CHAIN_VALID\" != \"true\" ]; then\n  echo \"‚ùå Audit chain integrity FAILED\"\n  echo $RESPONSE | jq '.tamperedEntries'\n  exit 1\nfi\n\necho \"‚úÖ Audit chain integrity verified\"\n\n# 2. Verify double-entry balance\npsql -U tala_user -d tala_db -t -c \"\n  SELECT \n    CASE WHEN SUM(debit) = SUM(credit) THEN 'BALANCED' ELSE 'UNBALANCED' END\n  FROM journal_detail;\n\"\n\n# 3. Verify tenant isolation\npsql -U tala_user -d tala_db -t -c \"\n  SELECT COUNT(*) FROM (\n    SELECT tenant_id FROM journal_entry\n    EXCEPT\n    SELECT id FROM tenant\n  ) orphans;\n\"  # Should return 0\n\necho \"‚úÖ Data integrity checks passed\"\n```\n\n---\n\n## Access Controls for Backup Media\n\n### IAM Policy (AWS S3)\n\n```json\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"arn:aws:iam::ACCOUNT:role/TALABackupRole\"\n      },\n      \"Action\": [\n        \"s3:PutObject\",\n        \"s3:PutObjectAcl\"\n      ],\n      \"Resource\": \"arn:aws:s3:::tala-backups/*\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"s3:x-amz-server-side-encryption\": \"AES256\"\n        }\n      }\n    },\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"arn:aws:iam::ACCOUNT:role/TALARestoreRole\"\n      },\n      \"Action\": [\n        \"s3:GetObject\",\n        \"s3:ListBucket\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::tala-backups\",\n        \"arn:aws:s3:::tala-backups/*\"\n      ]\n    }\n  ]\n}\n```\n\n### MFA Requirement for Restore Operations\n\n```bash\n# Require MFA token for restore role assumption\naws sts assume-role \
  --role-arn arn:aws:iam::ACCOUNT:role/TALARestoreRole \
  --role-session-name restore-session \
  --serial-number arn:aws:iam::ACCOUNT:mfa/operator \
  --token-code 123456\n```\n\n---\n\n## Communication Plan\n\n### Notification Matrix\n\n| Event | Internal | External | Channel | SLA |\n|-------|----------|----------|---------|-----|\n| Disaster Declared | CTO, DevOps Team | - | Slack #incident | Immediate |\n| Recovery Started | All Engineering | - | Slack #general | 15 min |\n| Service Degraded | Engineering | Tenant Admins | Email, Status Page | 30 min |\n| Service Restored | All Staff | All Tenants | Email, Status Page | 1 hour |\n| Post-Mortem | Leadership | Affected Tenants | Email, Doc | 48 hours |\n\n### Status Page Updates\n\n```\nIncident: Database Recovery in Progress\nStatus: Investigating ‚Üí Identified ‚Üí Monitoring ‚Üí Resolved\nImpact: All services unavailable\nETR: 2026-01-14 18:00 UTC (4 hours)\nUpdates: Every 30 minutes\n```\n\n---\n\n## Open Items & Roadmap\n\n### Q1 2026 (Priority)\n- [ ] Finalize S3 bucket configuration and lifecycle policies\n- [ ] Automate daily backup job (cron + monitoring)\n- [ ] Implement backup success/failure alerting (PagerDuty)\n- [ ] Conduct first full restore drill\n- [ ] Document actual RTO from drill\n\n### Q2 2026\n- [ ] Migrate document storage to S3\n- [ ] Set up cross-region replication (backup redundancy)\n- [ ] Implement backup encryption key rotation\n- [ ] Automate restore testing (monthly mini-drills)\n- [ ] Create DR dashboard (backup status, drill results)\n\n### Q3 2026\n- [ ] Evaluate disaster recovery as a service (DRaaS)\n- [ ] Implement geo-redundant PostgreSQL (streaming replication)\n- [ ] Set up hot standby database (reduce RTO to <1 hour)\n- [ ] Conduct chaos engineering exercises\n\n---\n\n**Last Updated**: 2026-01-14  \n**Next Drill**: 2026-03-15  \n**Owner**: Infrastructure Team  \n**Review Cycle**: Quarterly
